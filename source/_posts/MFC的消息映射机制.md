title: MFC的消息映射机制
date: 2014-12-25 09:55:25
categories: [Windows]
tags: 读书笔记
description:
---

> windows是利用消息机来进行通信的，在SDK下面的消息映射机制和MFC下面的稍有不同。这里只介绍MFC的消息映射机制。此文和晚些POST上的关于多线程的一篇文章里面的一个聊天室的项目相关联。

## 消息传递和执行的准备工作
对于MFC中的消息传递，不需要像SDK下那样复杂的步骤，总体来讲只有三点：<br>
1. 对应类中头文件的消息响应函数的声明<br>
2. 对应类源文件中的消息映射宏<br>
3. 对应类源文件中的消息响应函数的具体实现

可以这么说，MFC的消息映射机制，都是基于这三步互相关联而来的。

## 消息响应函数的声明
想处理一个消息必然要有相应的响应函数来处理。那么要在对应类中的头文件里面进行声明这个函数。声明这个函数和一般的函数不太相同。如果是我们自定义的消息，自定义这个消息对应的响应函数的话，那么我们可以以这种形式来声明这个消息响应函数。<br>
	
```c++
	
	//{{AFX_MSG(对应类)
	afx_msg void OnLButtonDown(UNIT nFlags, CPoint point); //消息响应函数
	//AFX_MSG
	DECLARE_MESSAGE_MAP()

```
可以看出函数限定符是afx_msg表明这是一个消息响应函数，他夹在两个AFX_MSG注释宏中间，即使自定义多个消息响应函数，他们的声明可以都放在这两个注释宏中间，这是整个类里面，消息响应函数声明的地方。
<br>
## 消息映射宏
在类的源文件中，还要添加响应的消息宏，他和消息响应函数将会被关联起来。消息映射宏存在放一个叫做消息映射表的结构里面。

```c

	BEGIN MESSAGE_MAP(类名，CView)    //消息映射表的起点
	//{{AFX_MSG_MAP(对应类)
	//具体的消息映射宏
	//AFX_MSG_MAP
	...
	END_MESSAGE_MAP()					//消息映射表的终点
	
```
<br>
## 消息响应函数
根据前面的函数声明，在函数类的源文件中实现消息响应函数。由此可知，在MFC消息传递的过程当中，程序中出现和消息传递相关的就只有三处：消息响应函数的声明，消息映射表以及消息响应函数的具体定义。
<br>

## 消息机制实现过程
在每一个能够接受和发送消息的类中，都会创建一个消息，一个消息映射表，一个消息响应函数的声明和具体的定义。当有消息处理的时候，我们就要在消息映射表中查找看类能不能处理这个消息，消息映射表中，消息的类型和处理消息的函数地址都是一一对应的，如果能够处理这类消息，我们就要查找看是否有处理这个消息的具体方法函数。如果有的话就会执行。
<br>
实际上在实现的过程中，在执行我们自己创建的三部分之前，还要有一系列的步骤。MFC中任何一个消息都是和窗口相关联的，每一个窗口的句柄都会和当前类对象的一个指针进行关联，当出现一个消息的时候，我们就能够通过消息携带的一些参数找出这个消息和哪一个窗口句柄相关，然后找到他相对应的类对象指针，把这个类对象的指针，传递给这个窗口类的基类，基类中会调用一个windowproc的函数，这个函数内部会执行一个叫做OnWndMsg的函数，这个函数是真正的消息映射函数。因为传递给windowproc函数的是窗口类对象的指针，所以在OnWndMsg函数内，我们可以查找，窗口类头文件中是否有所需要的响应函数声明，然后再去查看消息映射表，看是否有相应的函数映射宏。如果上述步骤都成功执行，那么，就会顺利的调用消息响应函数来处理这个消息。

